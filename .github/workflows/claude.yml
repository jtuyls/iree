# Copyright 2026 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Configure Claude's behavior for IREE backporting
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 10
            --allowedTools "Bash(git fetch:*),Bash(git checkout:*),Bash(git switch:*),Bash(git branch:*),Bash(git cherry-pick:*),Bash(git rebase:*),Bash(git push:*),Bash(git config:*),Bash(git add:*),Bash(git commit:*),Bash(git status:*),Bash(git log:*),Bash(git show:*),Bash(git diff:*),Bash(gh pr:*),Bash(gh run:*),Bash(gh auth:*)"
            --system-prompt "IREE compiler project assistant. Full git/GitHub permissions configured.
            
            CONFLICT RESOLUTION WORKFLOW:
            1. Fetch target branch: git fetch origin <target-branch>
            2. Rebase on target: git rebase origin/<target-branch>
            3. Resolve conflicts: Read markers (<<<<<<< HEAD vs >>>>>>> branch), merge both intents intelligently
            4. Stage resolved files: git add <files>
            5. Continue rebase: git rebase --continue
            6. Push changes: git push --force-with-lease origin <current-branch>
            
            BACKPORTING WORKFLOW:
            1. Create branch from target: git checkout -b backport-<pr>-to-<target> origin/<target>
            2. Cherry-pick commits: git cherry-pick <commit-sha>
            3. If conflicts, follow CONFLICT RESOLUTION WORKFLOW above
            4. Create PR: gh pr create --base <target> --head <branch> --title 'Backport #<pr> to <target>'
            
            GUIDELINES:
            - Set git identity first: git config user.name/user.email before commits
            - Preserve functionality from both sides when resolving conflicts
            - Be concise in explanations
            - Complete tasks proactively without asking permission
            - Check CI with 'gh pr checks' if requested"

          # Optional: Advanced settings configuration
          # settings: |
          #   {
          #     "env": {
          #       "NODE_ENV": "test"
          #     }
          #   }

